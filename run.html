<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dvojtapov√Ω ƒåasovac√≠ √ökol</title>

  <!-- JATOS (jen na serveru) -->
  <script src="jatos.js"></script>

  <!-- jsPsych v7 -->
  <link href="jspsych/jspsych.css" rel="stylesheet" />
  <script src="jspsych/jspsych.js"></script>
  <script src="jspsych/plugin-html-button-response.js"></script>

  <style>
  /* z√°kladn√≠ typografie a odsazen√≠ */
  body {
    font-family: sans-serif;
    margin: 16px;
    font-size: 1.2rem;          /* fallback pro star≈°√≠ prohl√≠≈æeƒçe */
  }

  /* zvƒõt≈°en√≠ textu uvnit≈ô v≈°ech jsPsych trial≈Ø */
  .jspsych-display-element,
  .jspsych-content {
    font-size: 1.35rem;         /* ‚âà 21 px na mobilu */
    line-height: 1.4;
  }

  /* odstavce */
  p { margin: .4em 0; }

  /* nadpisy */
  h2 {
    font-size: 1.9rem;          /* ‚âà 30 px */
    margin-bottom: .6em;
  }

  /* pohodln√° velk√° tlaƒç√≠tka */
  .jspsych-btn {
    font-size: 1.5rem;          /* ‚âà 24 px */
    padding: 1.2em 2.2em;
    border-radius: 14px;
  }
</style>
</head>
<body>

<script>
/* ------------------------------------------------------------------ */
/* 0)  Utility: konzolov√© logov√°n√≠                                     */
function log(...a) { console.log('[DOUBLE-TAP]', ...a); }

/* ------------------------------------------------------------------ */
/* 1)  Bƒõ≈æ√≠me na JATOSu?                                               */
const runOnServer = (typeof jatos !== 'undefined');
log('Str√°nka naƒçtena ‚Äî JATOS =', runOnServer);

/* ------------------------------------------------------------------ */
/* 2)  Inicializace jsPsych                                            */
const jsPsych = initJsPsych({
  on_finish: () => {
    log('Experiment dokonƒçen. ≈ò√°dk≈Ø v datab√°zi:', jsPsych.data.get().count());
    if (runOnServer) {
      jatos.submitResultData(jsPsych.data.get().json());
      jatos.endStudy();
    } else {
      jsPsych.data.displayData();
    }
  }
});
log('jsPsych v' + jsPsych.version + ' inicializov√°n.');

/* ------------------------------------------------------------------ */
/* 3)  Parametry experimentu                                           */
const NT_REPEATS = 4;                 // kolikr√°t ka≈æd√Ω interval
const targetTimes = [1.23, 2.45];     // s
const chosen      = jsPsych.randomization.sampleWithoutReplacement(targetTimes, 2);
const timelineVars= chosen.flatMap(t => Array(NT_REPEATS).fill({ time: t }));
log('Vybran√© ƒçasy:', chosen, ' √ó', NT_REPEATS);

/* ------------------------------------------------------------------ */
/* 4)  Neviditeln√© full-screen tlaƒç√≠tko                                */
const invisibleBtn =
  '<button class="jspsych-btn" ' +
  'style="opacity:0;position:fixed;top:0;left:0;width:100vw;height:100vh;' +
  'border:none;"></button>';

/* ------------------------------------------------------------------ */
/* 5)  Instrukce                                                       */
const instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>Instrukce</h2>
    <p>V psychologick√©m v√Ωzkumu ƒçasto pou≈æ√≠v√°me <em>reakƒçn√≠&nbsp;ƒças</em> jako
       jedno z&nbsp;objektivn√≠ch mƒõ≈ô√≠tek p≈ôesnosti.</p>
    <p>V ka≈æd√©m pokusu uvid√≠te c√≠lov√Ω interval v&nbsp;sekund√°ch.</p>
    <p>Po kliknut√≠ na <strong>Start</strong> m√°te a≈æ
       <strong>10&nbsp;s</strong> na prvn√≠ kliknut√≠ kdekoli na obrazovce.</p>
    <p>Pot√© m√°te kliknout podruh√© tak, abyste dos√°hli c√≠lov√©ho ƒçasu.</p>
    <p>Ka≈æd√Ω interval se opakuje 4√ó, celkem 8&nbsp;pokus≈Ø.</p>
    <p>Ihned po druh√©m tapu uvid√≠te zpƒõtnou vazbu, o&nbsp;kolik jste se
       od c√≠lov√©ho ƒçasu odch√Ωlili.</p>
    <p>Jak p≈ôesnƒõ se dok√°≈æete trefit?</p>
  `,
  choices: ['Start'],
  on_finish: () => log('Instrukce ukonƒçeny; zaƒç√≠n√°me mƒõ≈ôen√≠.')
};

/* ------------------------------------------------------------------ */
/* 6)  Procedura pro jeden dvoj-tap                                    */
let tapStart   = null;      // ms od navigation start
let absDiff    = null;      // aktu√°ln√≠ odchylka
let targetNow  = null;      // aktu√°ln√≠ c√≠l (s)

/* funkce, kter√° podle odchylky vr√°t√≠ emoji */
function feedbackEmoji(diff) {
  if (diff < 0.05) return 'ü§©';          // super p≈ôesn√©
  if (diff < 0.10) return 'üòÑ';          // velmi dobr√©
  if (diff < 0.20) return 'üôÇ';          // dobr√©
  if (diff < 0.50) return 'üòê';          // neutr√°ln√≠
  if (diff < 1.00) return 'üòï';          // mimo
  return 'üòü';                           // hodnƒõ mimo
}

const doubleTap = {
  timeline_variables: timelineVars,
  randomize_order: true,
  timeline: [

    /* ---------- prvn√≠ tap ---------- */
    {
      type: jsPsychHtmlButtonResponse,
      stimulus: () => {
        const t = jsPsych.timelineVariable('time').toFixed(2);
        return `<p><strong>C√≠lov√Ω interval&nbsp;${t}&nbsp;s</strong><br>
                ≈•uknƒõte poprv√© a poƒç√≠tejte‚Ä¶</p>`;
      },
      choices: [''],
      button_html: invisibleBtn,
      data: {
        tap: 1,
        time: () => jsPsych.timelineVariable('time')
      },
      on_finish: d => {
        tapStart  = performance.now();
        targetNow = d.time;
        log(`Prvn√≠ tap ‚Äî c√≠l ${targetNow}s, ƒças ${tapStart.toFixed(1)}ms`);
      }
    },

    /* ---------- druh√Ω tap ---------- */
    {
      type: jsPsychHtmlButtonResponse,
      stimulus: '',
      choices: [''],
      button_html: invisibleBtn,
      data: {
        tap: 2,
        time: () => jsPsych.timelineVariable('time')
      },
      on_finish: d => {
        const elapsed = (performance.now() - tapStart) / 1000;  // s
        d.measured    = elapsed;
        absDiff       = Math.abs(elapsed - targetNow);
        log(`Druh√Ω tap ‚Äî namƒõ≈ôeno ${elapsed.toFixed(3)}s; odchylka ${absDiff.toFixed(3)}s`);
      }
    },

    /* ---------- okam≈æit√° zpƒõtn√° vazba ---------- */
    {
      type: jsPsychHtmlButtonResponse,
      stimulus: () => {
        const diff = absDiff ?? 0;
        return `<p>C√≠lov√Ω interval: <strong>${targetNow.toFixed(2)}&nbsp;s</strong><br>
                Va≈°e odchylka: <strong>${diff.toFixed(3)}&nbsp;s</strong>
                ${feedbackEmoji(diff)}</p>`;
      },
      choices: ['Pokraƒçovat']
    }
  ]
};

/* ------------------------------------------------------------------ */
/* 7)  Souhrn                                                          */
function summaryEmoji(avg) {
  if (avg < 0.05) return 'üèÜ';
  if (avg < 0.10) return 'ü§©';
  if (avg < 0.20) return 'üòÑ';
  if (avg < 0.50) return 'üôÇ';
  if (avg < 1.00) return 'üòê';
  return 'üòï';
}

const results = {
  type: jsPsychHtmlButtonResponse,
  stimulus: () => {
    const taps2 = jsPsych.data.get().filter({ tap: 2 }).values();
    const byT   = {};

    taps2.forEach(d => {
      const key = d.time.toFixed(2);
      const diff= Math.abs(d.measured - d.time);
      (byT[key] = byT[key] || []).push(diff);
    });

    let html = '<h2>Souhrn odchylek</h2>';
    for (const t in byT) {
      const arr = byT[t];
      const min = Math.min(...arr).toFixed(3);
      const max = Math.max(...arr).toFixed(3);
      const avg = (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(3);
      html += `<p><strong>${t}&nbsp;s</strong> ‚Üí min&nbsp;${min}s, max&nbsp;${max}s,
               pr≈Ømƒõr&nbsp;${avg}s&nbsp;${summaryEmoji(parseFloat(avg))}</p>`;
    }
    return html;
  },
  choices: ['Dokonƒçit'],
  on_finish: () => log('Souhrn zobrazen ‚Äî konec experimentu.')
};

/* ------------------------------------------------------------------ */
/* 8)  Spu≈°tƒõn√≠                                                        */
log('Spou≈°t√≠m timeline‚Ä¶');
jsPsych.run([instructions, doubleTap, results]);
</script>

</body>
</html>
