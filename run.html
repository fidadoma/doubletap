<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DvojtapovÃ½ ÄŒasovacÃ­ Ãškol</title>

  <!-- JATOS (jen na serveru) -->
  <script src="jatos.js"></script>

  <!-- jsPsych v7 z CDN -->
  <link  href="https://unpkg.com/jspsych@7.3.1/css/jspsych.css" rel="stylesheet" />
  <script src="https://unpkg.com/jspsych@7.3.1"></script>

  <!-- plugin html-button-response -->
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script>

  <!-- ---------- STYLES ---------- -->
  <style>
    /* zÃ¡kladnÃ­ typografie a odsazenÃ­ */
    body            { font-family: sans-serif; margin: 16px; font-size: 1.2rem; }
    .jspsych-display-element,
    .jspsych-content{ font-size: 1.35rem; line-height: 1.4; }
    p               { margin: .4em 0; }
    h2              { font-size: 1.9rem; margin-bottom: .6em; }
    .jspsych-btn    { font-size: 1.5rem; padding: 1.2em 2.2em; border-radius: 14px; }
  </style>
</head>
<body>

<script>
/* ------------------------------------------------------------------ */
/* 0)  Utility: konzolovÃ© logovÃ¡nÃ­                                     */
const log = (...a) => console.log('[DOUBLE-TAP]', ...a);

/* ------------------------------------------------------------------ */
/* 1)  BÄ›Å¾Ã­me na JATOSu?                                               */
const runOnServer = (typeof jatos !== 'undefined');
log('StrÃ¡nka naÄtena â€” JATOS =', runOnServer);

/* ------------------------------------------------------------------ */
/* 2)  Inicializace jsPsych                                            */
const jsPsych = initJsPsych({
  on_finish: () => {
    log('Experiment dokonÄen, Å™Ã¡dky dat:', jsPsych.data.get().count());
    if (runOnServer) {
      jatos.submitResultData(jsPsych.data.get().json());
      jatos.endStudy();
    } else {
      jsPsych.data.displayData();
    }
  }
});
log('jsPsych ' + jsPsych.version + ' inicializovÃ¡n.');

/* ------------------------------------------------------------------ */
/* 3)  Parametry & promÄ›nnÃ©                                            */
const NT_REPEATS   = 4;
const targetTimes  = [1.23, 2.45];                       // s
const chosen       = jsPsych.randomization.sampleWithoutReplacement(targetTimes, 2);
const timelineVars = chosen.flatMap(t => Array(NT_REPEATS).fill({ time: t }));
log('VybranÃ© Äasy:', chosen, 'Ã—', NT_REPEATS);

/* ------------------------------------------------------------------ */
/* 4)  NeviditelnÃ© full-screen tlaÄÃ­tko                                */
const invisibleBtn =
  '<button class="jspsych-btn" style="opacity:0;position:fixed;top:0;left:0;width:100vw;height:100vh;border:none;"></button>';

/* ------------------------------------------------------------------ */
/* 5)  Instrukce (1/3)                                                 */
const instructions1 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>Instrukce (1/3)</h2>
    <p>V psychologickÃ©m vÃ½zkumu Äasto pouÅ¾Ã­vÃ¡me <em>reakÄnÃ­&nbsp;Äas</em> jako
       jedno z&nbsp;objektivnÃ­ch mÄ›Å™Ã­tek pÅ™esnosti.</p>
    <p>V kaÅ¾dÃ©m pokusu uvidÃ­te cÃ­lovÃ½ interval v&nbsp;sekundÃ¡ch.</p>
    <p>PotÃ© kliknÄ›te podruhÃ© tak, abyste vystihli cÃ­lovÃ½ Äas.</p>
  `,
  choices: ['PokraÄovat']
};

/* ------------------------------------------------------------------ */
/*  Instrukce (2/3) â€” BARVY + RAZÃTKO  // UPDATE â—„                     */
const instructions2 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>Instrukce (2/3)</h2>
    <p><strong>KÃ³dovÃ¡nÃ­ barvou:</strong></p>
    <ul>
      <li><span style="color:#000;font-weight:bold">ÄŒernÃ½</span> text = mÄ›Å™enÃ­ je
          <u>vypnutÃ©</u>.</li>
      <li><span style="color:#ff8800;font-weight:bold">OranÅ¾ovÃ½</span> text =
          mÄ›Å™enÃ­ <u>probÃ­hÃ¡</u> â€“ snaÅ¾te se kliknout podruhÃ© v&nbsp;Äas.</li>
    </ul>
    <p>KaÅ¾dÃ½ interval se opakuje 4Ã—, celkem 8&nbsp;pokusÅ¯.</p>
    
    <p>K&nbsp;pokraÄovÃ¡nÃ­ stisknÄ›te tlaÄÃ­tko.</p>
  `,
  choices: ['PokraÄovat']
};

/*  Instrukce (3/3) â€” BARVY + RAZÃTKO  // UPDATE â—„                     */
const instructions3 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>Instrukce (3/3)</h2>
    <p><strong>Bonus:</strong> Pokud dosÃ¡hnete u&nbsp;<em>obou</em> intervalÅ¯
       prÅ¯mÄ›rnÃ© odchylky menÅ¡Ã­ neÅ¾&nbsp;0,75&nbsp;s, zastavte se u&nbsp;stÃ¡nku
       pro razÃ­tko!</p>
    <p>K&nbsp;pokraÄovÃ¡nÃ­ stisknÄ›te tlaÄÃ­tko.</p>
  `,
  choices: ['Start']
};

/* ------------------------------------------------------------------ */
/* 6)  Dvoj-tap procedura                                              */
let tapStart   = null;      // ms od navigation start
let signedDiff = null;      // zÃ¡pornÃ¡ = rychlejÅ¡Ã­; kladnÃ¡ = pomalejÅ¡Ã­
let absDiff    = null;      // |signedDiff|
let targetNow  = null;      // aktuÃ¡lnÃ­ cÃ­l (s)

/* Emoji pro okamÅ¾itou zp. vazbu â€” jemnÄ›jÅ¡Ã­ Å¡kÃ¡la // UPDATE â—„ */
function feedbackEmoji(diff) {
  if (diff < 0.05) return 'ğŸ¤©';
  if (diff < 0.15) return 'ğŸ˜„';
  if (diff < 0.50) return 'ğŸ™‚';
  if (diff < 1.00) return 'ğŸ˜';
  if (diff < 2.00) return 'ğŸ˜•';
  return 'ğŸ˜Ÿ';
}

const doubleTap = {
  timeline_variables: timelineVars,
  randomize_order: true,
  timeline: [

    /* ---------- prvnÃ­ tap ---------- */
    {
      type: jsPsychHtmlButtonResponse,
      stimulus: () => {
        const t = jsPsych.timelineVariable('time').toFixed(2);
        return `<p><strong>CÃ­lovÃ½ interval ${t}&nbsp;s</strong><br>
                <span style="color:#000">KliknÄ›te poprvÃ© a zaÄnÄ›te poÄÃ­tatâ€¦</span></p>`;
      },
      choices: [''],
      button_html: invisibleBtn,
      data: {
        tap: 1,
        time: () => jsPsych.timelineVariable('time')
      },
      on_finish: d => {
        tapStart  = performance.now();
        targetNow = d.time;
        log(`PrvnÃ­ tap â†’ cÃ­l ${targetNow}s, Äas ${tapStart.toFixed(1)}ms`);
      }
    },

    /* ---------- druhÃ½ tap â€“ mÄ›Å™enÃ­ probÃ­hÃ¡ (ORANÅ½OVÃ text) ---------- */
    {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<p style="color:#ff8800;"><strong>MÄ›Å™Ã­me Äasâ€¦</strong><br>
                 KliknÄ›te podruhÃ©!</p>`,   //  UPDATE â—„
      choices: [''],
      button_html: invisibleBtn,
      data: {
        tap: 2,
        time: () => jsPsych.timelineVariable('time')
      },
      on_finish: d => {
        const elapsed   = (performance.now() - tapStart) / 1000;
        d.measured      = elapsed;

        signedDiff = elapsed - targetNow;
        absDiff    = Math.abs(signedDiff);

        log(`DruhÃ½ tap â€” namÄ›Å™eno ${elapsed.toFixed(3)} s; `
            + (signedDiff >= 0 ? 'pomalejÅ¡Ã­ o ' : 'rychlejÅ¡Ã­ o ')
            + `${absDiff.toFixed(3)} s`);
      }
    },

    /* ---------- okamÅ¾itÃ¡ zpÄ›tnÃ¡ vazba ---------- */
    {
      type: jsPsychHtmlButtonResponse,
      stimulus: () => {
        const diff = signedDiff ?? 0;
        const dir  = diff > 0 ? 'pomalejÅ¡Ã­' : diff < 0 ? 'rychlejÅ¡Ã­' : 'pÅ™esnÄ›';
        return diff === 0
          ? `<p>PÅ™esnÄ› na Äas! ğŸ¯</p>`
          : `<p>Byli jste o&nbsp;<strong>${Math.abs(diff).toFixed(3)} s</strong> ${dir}.</p>
             <p>${feedbackEmoji(Math.abs(diff))}</p>`;
      },
      choices: ['PokraÄovat']
    }
  ]
};

/* ------------------------------------------------------------------ */
/* 7)  Souhrn + podmÃ­nka na razÃ­tko // UPDATE â—„                        */
function summaryEmoji(avg) {
  if (avg < 0.05) return 'ğŸ†';
  if (avg < 0.15) return 'ğŸ¤©';
  if (avg < 0.50) return 'ğŸ™‚';
  if (avg < 1.00) return 'ğŸ˜';
  if (avg < 2.00) return 'ğŸ˜•';
  return 'ğŸ˜Ÿ';
}

const results = {
  type: jsPsychHtmlButtonResponse,
  stimulus: () => {
    const taps2 = jsPsych.data.get().filter({ tap: 2 }).values();
    const byT   = {};

    taps2.forEach(d => {
      const key  = d.time.toFixed(2);
      const diff = Math.abs(d.measured - d.time);
      (byT[key] = byT[key] || []).push(diff);
    });

    /* souhrnnÃ½ pÅ™ehled */
    let qualifies = true;
    let html      = '<h2>Souhrn odchylek</h2>';
    for (const t in byT) {
      const arr = byT[t];
      const min = Math.min(...arr).toFixed(3);
      const max = Math.max(...arr).toFixed(3);
      const avg = (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(3);
      html += `<p><strong>${t}&nbsp;s</strong> â†’ min&nbsp;${min}s, max&nbsp;${max}s,
               prÅ¯mÄ›r&nbsp;${avg}s&nbsp;${summaryEmoji(parseFloat(avg))}</p>`;
      if (parseFloat(avg) >= 0.75) qualifies = false;
    }

    /* razÃ­tko-check  // UPDATE â—„ */
    if (qualifies) {
      html += `<h3>ğŸ‰ Gratulujeme! U&nbsp;obou ÄasÅ¯ jste se prÅ¯mÄ›rnÄ›
               veÅ¡li do 0,75&nbsp;s.<br>
               Zastavte se na stÃ¡nku pro razÃ­tko.</h3>`;
    } else {
      html += `<p>RazÃ­tko tentokrÃ¡t nevyÅ¡lo â€“ mÅ¯Å¾ete to
               zkusit znovu!</p>`;
    }
    return html;
  },
  choices: ['PokraÄovat']
};

/* ------------------------------------------------------------------ */
/* 8)  PodÄ›kovÃ¡nÃ­ + moÅ¾nost restartu  // UPDATE â—„                      */
const thanks = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>DÄ›kujeme za ÃºÄast!</h2>
    <p>Experiment se nynÃ­ restartuje.</p>
  `,
  choices: ['Restartovat']
  
};

/* ------------------------------------------------------------------ */
/* 9)  SpuÅ¡tÄ›nÃ­ timeline                                               */
jsPsych.run([instructions1, instructions2, instructions3, doubleTap, results, thanks]);
</script>

</body>
</html>